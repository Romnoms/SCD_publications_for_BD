<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metabolic Diseases - SCD Publications Database</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <a href="../index.html" class="back-link">
                    <i class="fas fa-arrow-left"></i> Back to Home
                </a>
                <div class="category-header" style="border-left: 4px solid #059669;">
                    <div class="category-icon" style="background: #05966920; color: #059669;">
                        <i class="fas fa-heart-pulse"></i>
                    </div>
                    <div>
                        <h1>Metabolic Diseases</h1>
                        <p class="category-subtitle">79 publications across 4 subcategories</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input
                    type="text"
                    id="searchInput"
                    class="search-input"
                    placeholder="Search publications in this category..."
                    autocomplete="off"
                >
                <button onclick="clearSearch()" class="clear-button" id="clearBtn" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
                <div id="autocomplete-results" class="autocomplete-results"></div>
            </div>

            <!-- Filters -->
            <div class="search-filters">
                <label class="filter-checkbox">
                    <input type="checkbox" id="reviewsOnly">
                    <span>Reviews Only</span>
                </label>
                <label class="filter-checkbox">
                    <input type="checkbox" id="originalOnly">
                    <span>Original Research Only</span>
                </label>
                <select id="subcategoryFilter" class="filter-select">
                    <option value="">All Subcategories</option>
                    <option value="Obesity">Obesity (46)</option><option value="Diabetes">Diabetes (30)</option><option value="NAFLD/NASH">NAFLD/NASH (25)</option><option value="Metabolic Syndrome">Metabolic Syndrome (11)</option>
                </select>
                <select id="yearFilter" class="filter-select">
                    <option value="">All Years</option>
                </select>
            </div>
        </div>

        <!-- Subcategory Summary -->
        <div class="subcategory-summary">
            <h2>Subcategories</h2>
            <div class="subcategory-grid">
                
                <div class="subcategory-item" onclick="filterBySubcategory('Obesity')">
                    <h3>Obesity</h3>
                    <p class="paper-count">46 papers</p>
                </div>
                
                <div class="subcategory-item" onclick="filterBySubcategory('Diabetes')">
                    <h3>Diabetes</h3>
                    <p class="paper-count">30 papers</p>
                </div>
                
                <div class="subcategory-item" onclick="filterBySubcategory('NAFLD/NASH')">
                    <h3>NAFLD/NASH</h3>
                    <p class="paper-count">25 papers</p>
                </div>
                
                <div class="subcategory-item" onclick="filterBySubcategory('Metabolic Syndrome')">
                    <h3>Metabolic Syndrome</h3>
                    <p class="paper-count">11 papers</p>
                </div>
                
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" style="display: none;">
            <div id="searchResults"></div>
            <div id="noResults" class="no-results" style="display: none;">
                <i class="fas fa-search"></i>
                <p>No publications found matching your criteria</p>
            </div>
        </div>

        <!-- All Publications -->
        <div id="all-publications">
            <h2>
                All Publications
                <span class="publication-count-badge">79 papers</span>
            </h2>
            <div id="publicationList" class="publications-container"></div>
        </div>
    </div>

    <!-- Load category-specific data -->
    <script>
        const CATEGORY_FILTER = 'Metabolic Diseases';
    </script>
    <script src="../js/search.js"></script>
    <script>
        // Load and display all publications for this category on page load
        async function loadCategoryPublications() {
            try {
                const response = await fetch('../data/publications_search.json');
                const allPubs = await response.json();

                // Filter for this category
                const categoryPubs = allPubs.filter(p =>
                    p.categories.some(c => c.startsWith(CATEGORY_FILTER))
                );

                // Sort by year (newest first)
                categoryPubs.sort((a, b) => b.year.localeCompare(a.year));

                // Display all publications
                const listDiv = document.getElementById('publicationList');
                listDiv.innerHTML = categoryPubs.map(pub => renderPaperCard(pub)).join('');

                // Populate year filter
                const years = [...new Set(categoryPubs.map(p => p.year))].sort().reverse();
                const yearFilter = document.getElementById('yearFilter');
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilter.appendChild(option);
                });

                // Store globally for search
                window.categoryPublications = categoryPubs;
            } catch (error) {
                console.error('Error loading publications:', error);
            }
        }

        // Filter by subcategory when clicked
        function filterBySubcategory(subcategory) {
            document.getElementById('subcategoryFilter').value = subcategory;
            const event = new Event('change');
            document.getElementById('subcategoryFilter').dispatchEvent(event);
        }

        // Override search to use category publications
        const originalSearch = searchPublications;
        searchPublications = function(query) {
            if (!window.categoryPublications) return [];

            if (!query || query.length < 2) return [];

            const queryLower = query.toLowerCase();
            const reviewsOnly = document.getElementById('reviewsOnly').checked;
            const originalOnly = document.getElementById('originalOnly').checked;
            const subcategoryFilter = document.getElementById('subcategoryFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;

            let results = window.categoryPublications.filter(pub => {
                const matchesText = pub.search_text.includes(queryLower);

                if (reviewsOnly && !pub.is_review) return false;
                if (originalOnly && pub.is_review) return false;

                if (subcategoryFilter && !pub.categories.includes(`${CATEGORY_FILTER}: ${subcategoryFilter}`)) return false;
                if (yearFilter && pub.year !== yearFilter) return false;

                return matchesText;
            });

            results.sort((a, b) => {
                const aTitleMatch = a.title.toLowerCase().includes(queryLower);
                const bTitleMatch = b.title.toLowerCase().includes(queryLower);
                if (aTitleMatch && !bTitleMatch) return -1;
                if (!aTitleMatch && bTitleMatch) return 1;
                return b.year.localeCompare(a.year);
            });

            return results;
        };

        // Override displaySearchResults to show/hide sections
        const originalDisplayResults = displaySearchResults;
        displaySearchResults = function(results) {
            const resultsSection = document.getElementById('results-section');
            const allPublications = document.getElementById('all-publications');
            const subcategorySummary = document.querySelector('.subcategory-summary');

            if (results.length > 0 || document.getElementById('searchInput').value.length >= 2) {
                // Show search results, hide all publications
                resultsSection.style.display = 'block';
                allPublications.style.display = 'none';
                subcategorySummary.style.display = 'none';
            } else {
                // Show all publications, hide search results
                resultsSection.style.display = 'none';
                allPublications.style.display = 'block';
                subcategorySummary.style.display = 'block';
            }

            originalDisplayResults(results);
        };

        // Clear search function
        window.clearSearch = function() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearBtn').style.display = 'none';
            document.getElementById('autocomplete-results').classList.remove('show');
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('all-publications').style.display = 'block';
            document.querySelector('.subcategory-summary').style.display = 'block';

            // Reset filters
            document.getElementById('reviewsOnly').checked = false;
            document.getElementById('originalOnly').checked = false;
            document.getElementById('subcategoryFilter').value = '';
            document.getElementById('yearFilter').value = '';
        };

        // Load publications on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadCategoryPublications();

            // Show clear button when typing
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                document.getElementById('clearBtn').style.display = e.target.value ? 'block' : 'none';

                // If search is cleared, show all publications
                if (e.target.value === '') {
                    document.getElementById('results-section').style.display = 'none';
                    document.getElementById('all-publications').style.display = 'block';
                    document.querySelector('.subcategory-summary').style.display = 'block';
                }
            });

            // Scroll to top when a publication is clicked
            document.addEventListener('click', (e) => {
                if (e.target.closest('.paper-card')) {
                    // Smooth scroll to the clicked paper
                    e.target.closest('.paper-card').scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>
</body>
</html>
